<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Server Page</title>
<style>
body {
	font-family: sans-serif;
}
</style>
</head>
<body>
<h1>NFC Server</h1>
<textarea readonly rows="20" cols="50"></textarea>
<script>
function log(message) {
	console.log(message);
	const textarea = document.querySelector('textarea');
	textarea.value += message + '\n';
	textarea.scrollTop = textarea.scrollHeight;
}

let reconnectTries = 0;
function connect(connectionString, eventCallback) {
	log('WS: Opening ' + connectionString);
	const ws = new WebSocket(connectionString);

	ws.addEventListener('open', () => {
		log('WS: Opened');
		reconnectTries = 0;
	});

	ws.addEventListener('message', (event) => {
		const eventData = JSON.parse(event.data);
		const message = `${eventData.reader}: ${eventData.card}`;
		log(message);
		eventCallback(eventData.reader, eventData.card);
	});

	ws.addEventListener('close', () => {
		log('WS: Closed');

		// Schedule reconnection with backoff
		reconnectTries++;
		let reconnectInterval = (1.2 ** Math.min(reconnectTries, 10)) * 10;
		setTimeout(() => {
			connect(connectionString);
		}, reconnectInterval * 1000);
	});

	ws.addEventListener('error', (error) => {
		log(`WS: Error: ${error.message}`);
	});
}

// Track state
const cardState = {};
function cardChanged(reader, card) {
	const newReader = !(reader in cardState);
	const previousValue = newReader ? '' : cardState[reader];
	cardState[reader] = card;

	// Handle NFC events here
	log(`Event received - Reader: ${reader}, Card: ${card} - State: ${JSON.stringify(cardState)}`);
}

// Create websocket server
const connectionString = `ws://${location.host}/ws`;
connect(connectionString, cardChanged);

</script>
</body>
</html>